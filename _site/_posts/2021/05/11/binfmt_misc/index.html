<h1>How to execute JS like a binary</h1><p>There are dozens of binary file formats that supported by operating systems that we use. Binary format is standard that helps operating system to determine how to execute file: read content, load part of them into a memory, extract additional data etc.</p><p>How operating system determines how it should execute one or the other binary file? There are several ways to do that: one of that is to look at file extension. For example if you use Windows operating system, you can easily rename any text file to add <code>.exe</code>-extension and after that it will be looks like executable file, but, for sure, it cannot be executed because it doesn't follow structure of standard executable file for Windows.</p><p>Other way to determine that some file can be executed is read several first bytes of file. This first bytes called <a href="https://en.wikipedia.org/wiki/Magic_number_(programming)#In_files" target="_blank">magic number</a>. For example, in UNIX-like operating system, ELF file format, which is being commonly used, has magic number that consists of hexadecimal number <code>0x7F</code> and followed by <code>ELF</code> string. More interesting that Java class file and Mach-O file format, which is executable format for MacOS, have the same magic number: <code>CAFEBABE</code>. Creator of Java, James Gosling, even <a href="http://radio-weblogs.com/0100490/2003/01/28.html">explained</a> why he chose this magic number and if it has common with Mach-O executable file format.</p><p>If you are using UNIX-like operating system, you can easily check content of any files in your system on byte-level, i.e. using program <code>hexdump</code>. There is four bytes of executable <code>hexdump</code> on my MacBook that were represented by hexadecimal numbers:</p><pre><code class="hljs language-sh">~ hexdump -n 4 /usr/bin/hexdump
0000000 ca fe ba be
0000004
</code></pre><p>In linux executable file is executed by kernel and format of executable is determinated using either magic numbers or file extension. Built-in module <em>binfmt</em> is responsible for this process. In linux 5.9 you can find <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/fs?h=linux-5.9.y" target="_blank">seven</a> file formats that kernel supports out of box. And, surprisingly, one of the format is shebang scripts — scripts, that start with <code>#!</code> symbol combination. Thus, if you run, using your favorite shell program, script, which has permission to be executed, kernel will decide what to do with your script.</p><p>But the most interesting part of this mechanism that you can easily extend it using <a href="https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html" target="_blank">custom binary formats</a>. By default, your distribution has mounted folder <code>binfmt_misc</code> in <code>/proc/sys/fs</code>:</p><pre><code class="hljs language-sh">~ <span class="built_in">ls</span> /proc/sys/fs/binfmt_misc
register status
</code></pre><p>Using special <code>register</code> file you can register your custom executable file format that will be executed by your kernel. For example, we can instruct our kernel to execute javascript files with <code>.js</code> extension with <code>node</code> program in the future:</p><pre><code class="hljs language-sh"><span class="comment"># echo &quot;:nodejs:E::js::/usr/bin/node:&quot; &gt; /proc/sys/fs/binfmt_misc/register</span>
</code></pre><p>There are list of parameters, which delimited from each other using colons, that we specified in string:</p><ul><li><code>nodejs</code> — name of executable format;</li><li><code>E</code> — specify that we use file extension to determine file format. Other possible value of this parameter is <code>M</code>, which means that we should determine file format by magic number;</li><li><code>js</code> — value of target extension;</li><li><code>/usr/bin/node</code> — path to executable that will be used for executing of file.</li></ul><p>After that file <code>nodejs</code> should appears in the <code>/proc/sys/fs/binfmt_misc</code> folder:</p><pre><code class="hljs language-sh">~ <span class="built_in">ls</span> /proc/sys/fs/binfmt_misc
nodejs register status
</code></pre><p>This means that your first custom binary format just have registered. Let's create simple javascript file and execute it:</p><pre><code class="hljs language-sh">~ <span class="built_in">echo</span> <span class="string">&quot;console.log(&#x27;Hello, world!&#x27;)&quot;</span> &gt; index.js
~ <span class="built_in">chmod</span> +x ./index.js <span class="comment"># Add permission to execute file</span>
~ ./index.js
Hello, world!
</code></pre><p>Voila! Your JavaScript executable file format is ready for using.</p>